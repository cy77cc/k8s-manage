## Context

`k8s-manage` 当前已具备主机、集群、服务、部署等领域能力，但资源数据分散在多个域对象中，缺少统一 CMDB 层来承载“资产标准化 + 关系建模 + 变更审计”。

CMDB 能力将作为平台治理底座，服务于告警定位、变更评估、自动化编排与拓扑可视化。

## Goals / Non-Goals

**Goals:**
- 建立统一 CI 数据模型，覆盖核心 PaaS 资产类型。
- 建立关系模型与拓扑查询能力，支持按项目/集群/服务进行影响范围分析。
- 建立同步任务与审计记录，确保 CMDB 数据与业务域状态可追踪一致。
- 通过 `/api/v1/cmdb/*` 提供读写与同步接口，并接入 RBAC。

**Non-Goals:**
- 本期不实现全自动实时发现（先以定时/手动触发同步为主）。
- 本期不覆盖所有外部云资源类型（先覆盖现有平台已管理资产）。
- 本期不做复杂图数据库引入（先使用关系表 + 查询聚合）。

## Decisions

- 决策 1：采用关系型存储实现 CMDB 第一版。
  - 原因：现有项目栈以 GORM+MySQL 为主，迁移与运维成本最低。
  - 备选：引入图数据库（Neo4j/JanusGraph）；暂不采用，避免首期复杂度过高。

- 决策 2：CI 模型采用“通用字段 + 类型扩展属性(JSON)”结构。
  - 原因：兼顾统一检索与不同资产类型扩展性。
  - 备选：每类资产单独表；暂不采用，跨资产查询与统一审计成本高。

- 决策 3：同步采用“全量基线 + 增量对比”任务机制。
  - 原因：便于快速上线并具备差异可解释性。
  - 备选：纯事件驱动实时同步；暂不采用，依赖链和一致性边界更复杂。

- 决策 4：权限最小集固定为 `cmdb:read|write|sync|audit`。
  - 原因：与现有 RBAC 模式一致，便于前后端统一判定。
  - 备选：更细颗粒权限；后续根据使用情况再细化。

## Risks / Trade-offs

- [Risk] CMDB 与源域数据短时间不一致。
  - Mitigation: 为同步任务提供状态、错误、重试和差异明细。

- [Risk] 关系建模规则过于宽松导致拓扑噪音。
  - Mitigation: 增加关系合法性校验（类型约束、去重、循环检测）。

- [Risk] 初期查询性能受 JSON 属性过滤影响。
  - Mitigation: 对高频过滤字段建立冗余索引列。

## Migration Plan

1. 增加 migration：CMDB 核心表与索引。
2. 新增 `api/cmdb/v1` 合同与 `internal/service/cmdb` 路由/handler/logic。
3. 接入 RBAC 权限点与默认角色初始化脚本。
4. 实现同步任务执行器（手动触发 + 定时触发预留）。
5. 新增前端 API 模块与基础管理页面。
6. 增加测试与回归用例，验证核心流程。

Rollback strategy:
- 功能开关关闭 CMDB 路由入口；保留表结构但停止同步任务。
- 如需回滚 schema，执行 migration down。

## Open Questions

- 是否在本期纳入 Node/Project 域作为一级 CI 类型？
- CMDB 同步频率默认值（分钟级）应由配置文件还是数据库策略表控制？
- 拓扑查询是否需要首期支持时间维度（历史快照）？
